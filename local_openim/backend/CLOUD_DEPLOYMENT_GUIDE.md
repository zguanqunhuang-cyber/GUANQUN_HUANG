# ä¸Šäº‘åè®¿é—® OpenIM MongoDB çš„æ–¹æ¡ˆå¯¹æ¯”

## ğŸš« ä¸ºä»€ä¹ˆç›´æ¥è¯»å– MongoDB **ä¸æ¨è**ç”¨äºç”Ÿäº§ç¯å¢ƒ

### 1. **å®‰å…¨é£é™©** âš ï¸
- **æš´éœ²æ•°æ®åº“ç«¯å£**ï¼šäº‘ç«¯ MongoDB é€šå¸¸ä¸åº”è¯¥å¯¹å¤–å¼€æ”¾
- **è®¤è¯å¤æ‚**ï¼šéœ€è¦ç®¡ç†é¢å¤–çš„æ•°æ®åº“å‡­æ®
- **å®¡è®¡å›°éš¾**ï¼šç»•è¿‡åº”ç”¨å±‚ï¼Œéš¾ä»¥è¿½è¸ªè°è®¿é—®äº†ä»€ä¹ˆæ•°æ®
- **æƒé™æ§åˆ¶å¼±**ï¼šæ•°æ®åº“å±‚é¢çš„æƒé™æ§åˆ¶ä¸å¦‚åº”ç”¨å±‚ç»†ç²’åº¦

### 2. **æ¶æ„é—®é¢˜** ğŸ—ï¸
- **è¿ååˆ†å±‚åŸåˆ™**ï¼šè·³è¿‡ä¸šåŠ¡é€»è¾‘å±‚ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- **è€¦åˆåº¦é«˜**ï¼šä»£ç ç›´æ¥ä¾èµ–æ•°æ®åº“ç»“æ„ï¼Œå‡çº§å›°éš¾
- **æ‰©å±•æ€§å·®**ï¼šæ— æ³•åˆ©ç”¨ API Gatewayã€è´Ÿè½½å‡è¡¡ç­‰äº‘æœåŠ¡
- **ç›‘æ§ç›²åŒº**ï¼šæ— æ³•é€šè¿‡ API ç›‘æ§è¿½è¸ªä¸šåŠ¡æŒ‡æ ‡

### 3. **è¿ç»´æˆæœ¬** ğŸ’°
- **ç½‘ç»œé…ç½®å¤æ‚**ï¼šéœ€è¦é…ç½® VPNã€ä¸“çº¿æˆ–ç™½åå•
- **æ€§èƒ½å½±å“**ï¼šç›´æ¥æŸ¥è¯¢å¯èƒ½å½±å“ç”Ÿäº§æ•°æ®åº“æ€§èƒ½
- **å¤‡ä»½æ¢å¤éš¾**ï¼šç»•è¿‡åº”ç”¨å±‚çš„æ•°æ®ä¸€è‡´æ€§ä¿éšœ
- **ç‰ˆæœ¬å…¼å®¹**ï¼šOpenIM å‡çº§å¯èƒ½æ”¹å˜æ•°æ®åº“ç»“æ„

---

## âœ… æ¨èçš„ä¸Šäº‘æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä¿®å¤ OpenIM çš„ maxSeq é—®é¢˜ï¼ˆæœ€æ¨èï¼‰â­â­â­â­â­

**ä¸ºä»€ä¹ˆ maxSeq æ²¡æœ‰æ›´æ–°ï¼Ÿ**

å¯èƒ½çš„åŸå› ï¼š
1. **msgtransfer æœåŠ¡æœªæ­£å¸¸è¿è¡Œ**
2. **Kafka æ¶ˆæ¯é˜Ÿåˆ—é…ç½®é—®é¢˜**
3. **ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜**

**å¦‚ä½•ä¿®å¤ï¼š**

```bash
# 1. æ£€æŸ¥ msgtransfer æœåŠ¡çŠ¶æ€
docker ps | grep msgtransfer

# 2. æŸ¥çœ‹ msgtransfer æ—¥å¿—
docker logs openim-msgtransfer

# 3. æ£€æŸ¥ Kafka è¿æ¥
docker logs openim-kafka

# 4. æ‰‹åŠ¨è§¦å‘ä¼šè¯åŒæ­¥ï¼ˆå¦‚æœæœ‰ç›¸å…³è„šæœ¬ï¼‰
# æˆ–è€…é‡å¯ç›¸å…³æœåŠ¡
docker restart openim-msgtransfer
```

**ä¿®å¤åçš„å¥½å¤„ï¼š**
- âœ… REST API æ­£å¸¸å·¥ä½œ
- âœ… æ ‡å‡†åŒ–æ¥å£ï¼Œæ˜“äºç»´æŠ¤
- âœ… å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘ä¿éšœ
- âœ… äº‘ç«¯éƒ¨ç½²é›¶ä¿®æ”¹

---

### æ–¹æ¡ˆ B: ä½¿ç”¨ REST API + å¤‡ç”¨æ–¹æ¡ˆï¼ˆæ¨èï¼‰â­â­â­â­

**ä¸»æ–¹æ¡ˆï¼šREST API**
```python
# ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ REST API
API_URL = os.getenv("OPENIM_API_URL", "https://api.yourdomain.com")

def get_messages_via_api(user_id):
    # æ ‡å‡†çš„ REST API è°ƒç”¨
    # æœ‰å®Œæ•´çš„è®¤è¯ã€æˆæƒã€å®¡è®¡
    pass
```

**å¤‡ç”¨æ–¹æ¡ˆï¼šåªè¯»å‰¯æœ¬**
```python
# ä»…ç”¨äºæ•°æ®åˆ†æã€æŠ¥è¡¨ç­‰éå®æ—¶åœºæ™¯
# è¿æ¥åˆ°åªè¯»å‰¯æœ¬ï¼Œä¸å½±å“ç”Ÿäº§åº“
READONLY_MONGO_URI = os.getenv("MONGO_READONLY_URI")

def get_messages_for_analytics(user_id):
    # ä»…ç”¨äºç¦»çº¿åˆ†æ
    # è¿æ¥åªè¯»å‰¯æœ¬
    pass
```

**æ¶æ„å›¾ï¼š**
```
ç”¨æˆ·è¯·æ±‚
  â†“
REST API (ä¸»è¦) â”€â”€â†’ OpenIM Server â”€â”€â†’ MongoDB (ä¸»åº“)
  â†“                                      â†“
  â†“                                   å¤åˆ¶
  â†“                                      â†“
æ•°æ®åˆ†æ (å¤‡ç”¨) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ MongoDB (åªè¯»å‰¯æœ¬)
```

---

### æ–¹æ¡ˆ C: æ•°æ®åŒæ­¥åˆ°åˆ†æåº“ï¼ˆé€‚åˆå¤§è§„æ¨¡ï¼‰â­â­â­â­

**é€‚ç”¨åœºæ™¯ï¼š**
- éœ€è¦å¤æ‚çš„æ•°æ®åˆ†æ
- éœ€è¦è·¨ç³»ç»Ÿæ•°æ®æ•´åˆ
- ä¸æƒ³å½±å“ç”Ÿäº§æ•°æ®åº“æ€§èƒ½

**å®ç°æ–¹å¼ï¼š**

#### 1. ä½¿ç”¨ MongoDB Change Streamsï¼ˆå®æ—¶åŒæ­¥ï¼‰
```python
from pymongo import MongoClient

# ç›‘å¬ MongoDB å˜æ›´
def sync_messages_realtime():
    client = MongoClient(PROD_MONGO_URI)
    db = client['openim_v3']
    
    # ç›‘å¬ msg é›†åˆçš„å˜æ›´
    with db.msg.watch() as stream:
        for change in stream:
            if change['operationType'] == 'insert':
                # åŒæ­¥åˆ°åˆ†æåº“
                sync_to_analytics_db(change['fullDocument'])
```

#### 2. å®šæœŸæ‰¹é‡åŒæ­¥ï¼ˆT+1 åˆ†æï¼‰
```python
from apscheduler.schedulers.blocking import BlockingScheduler

def sync_messages_daily():
    """æ¯å¤©å‡Œæ™¨åŒæ­¥å‰ä¸€å¤©çš„æ¶ˆæ¯"""
    yesterday = datetime.now() - timedelta(days=1)
    
    # ä»ç”Ÿäº§åº“è¯»å–
    messages = fetch_from_prod(yesterday)
    
    # å†™å…¥åˆ†æåº“
    write_to_analytics(messages)

scheduler = BlockingScheduler()
scheduler.add_job(sync_messages_daily, 'cron', hour=2)
scheduler.start()
```

#### 3. ä½¿ç”¨ ETL å·¥å…·ï¼ˆä¼ä¸šçº§ï¼‰
```yaml
# ä½¿ç”¨ Apache Airflow / Airbyte ç­‰å·¥å…·
source:
  type: mongodb
  uri: mongodb://prod-mongo:27017
  database: openim_v3
  collection: msg

destination:
  type: postgresql  # æˆ–å…¶ä»–åˆ†ææ•°æ®åº“
  uri: postgresql://analytics-db:5432
  
schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
```

---

## ğŸŒ äº‘ç«¯éƒ¨ç½²çš„æœ€ä½³å®è·µ

### 1. ç½‘ç»œæ¶æ„

```
Internet
   â†“
API Gateway (HTTPS)
   â†“
Load Balancer
   â†“
OpenIM API Servers (å¤šå®ä¾‹)
   â†“
â”œâ”€â†’ Redis (ç¼“å­˜)
â”œâ”€â†’ Kafka (æ¶ˆæ¯é˜Ÿåˆ—)
â””â”€â†’ MongoDB (ä¸»åº“)
      â†“
   åªè¯»å‰¯æœ¬ (ä»…é™å†…ç½‘è®¿é—®)
      â†“
   åˆ†ææœåŠ¡ (Python åç«¯)
```

### 2. å®‰å…¨é…ç½®

```yaml
# MongoDB å®‰å…¨é…ç½®
mongodb:
  # ä¸å¯¹å¤–å¼€æ”¾
  bindIp: 127.0.0.1
  
  # å¯ç”¨è®¤è¯
  auth: enabled
  
  # ä½¿ç”¨å¼ºå¯†ç 
  users:
    - name: openim_app
      password: <strong-password>
      roles: [readWrite]
    
    - name: openim_readonly
      password: <strong-password>
      roles: [read]  # åªè¯»æƒé™
  
  # å¯ç”¨ SSL
  ssl:
    mode: requireSSL
    PEMKeyFile: /path/to/cert.pem
```

### 3. è®¿é—®æ§åˆ¶

```python
# ç¯å¢ƒå˜é‡é…ç½®
import os

class Config:
    # ç”Ÿäº§ç¯å¢ƒï¼šåªä½¿ç”¨ REST API
    if os.getenv('ENV') == 'production':
        USE_API = True
        USE_DIRECT_DB = False
        API_URL = os.getenv('OPENIM_API_URL')
    
    # å¼€å‘ç¯å¢ƒï¼šå¯ä»¥ç›´è¿æ•°æ®åº“
    elif os.getenv('ENV') == 'development':
        USE_API = False
        USE_DIRECT_DB = True
        MONGO_URI = os.getenv('MONGO_URI')
    
    # åˆ†æç¯å¢ƒï¼šåªè¯»å‰¯æœ¬
    elif os.getenv('ENV') == 'analytics':
        USE_API = False
        USE_DIRECT_DB = True
        MONGO_URI = os.getenv('MONGO_READONLY_URI')
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”è¡¨

| æ–¹æ¡ˆ | å®‰å…¨æ€§ | æ€§èƒ½ | ç»´æŠ¤æˆæœ¬ | æ‰©å±•æ€§ | æ¨èåº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|----------|--------|--------|----------|
| **REST API** | â­â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | ç”Ÿäº§ç¯å¢ƒ |
| **ç›´è¿ä¸»åº“** | â­ | â­â­ | â­â­ | â­ | â­ | **ä¸æ¨è** |
| **åªè¯»å‰¯æœ¬** | â­â­â­ | â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­â­ | æ•°æ®åˆ†æ |
| **æ•°æ®åŒæ­¥** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | å¤§è§„æ¨¡åˆ†æ |

---

## ğŸ¯ å…·ä½“å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
1. **ä¿®å¤ maxSeq é—®é¢˜**
   - æ£€æŸ¥ msgtransfer æœåŠ¡
   - æŸ¥çœ‹æ—¥å¿—æ‰¾å‡ºæ ¹æœ¬åŸå› 
   - é‡å¯ç›¸å…³æœåŠ¡

2. **éªŒè¯ REST API**
   ```bash
   python3 experiment_history.py
   # åº”è¯¥èƒ½æ­£å¸¸è·å–æ¶ˆæ¯
   ```

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰
1. **å‡†å¤‡ä¸Šäº‘**
   - é…ç½® HTTPS å’ŒåŸŸå
   - è®¾ç½® API Gateway
   - é…ç½®ç›‘æ§å’Œå‘Šè­¦

2. **ä»£ç é€‚é…**
   ```python
   # ç»Ÿä¸€ä½¿ç”¨ç¯å¢ƒå˜é‡
   API_URL = os.getenv('OPENIM_API_URL', 'http://localhost:10002')
   ```

### é•¿æœŸï¼ˆ3-6æœˆï¼‰
1. **å¦‚æœéœ€è¦æ•°æ®åˆ†æ**
   - éƒ¨ç½² MongoDB åªè¯»å‰¯æœ¬
   - é…ç½®å†…ç½‘è®¿é—®
   - æˆ–ä½¿ç”¨æ•°æ®åŒæ­¥æ–¹æ¡ˆ

2. **ç›‘æ§å’Œä¼˜åŒ–**
   - API æ€§èƒ½ç›‘æ§
   - æ•°æ®åº“æ…¢æŸ¥è¯¢ä¼˜åŒ–
   - ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

---

## âš ï¸ ç‰¹åˆ«æ³¨æ„

### ä»€ä¹ˆæ—¶å€™å¯ä»¥ç›´è¿ MongoDBï¼Ÿ

**å¯ä»¥ï¼š**
- âœ… æœ¬åœ°å¼€å‘ç¯å¢ƒ
- âœ… åªè¯»å‰¯æœ¬ï¼ˆä»…é™å†…ç½‘ï¼‰
- âœ… æ•°æ®åˆ†æå’ŒæŠ¥è¡¨
- âœ… ä¸€æ¬¡æ€§æ•°æ®è¿ç§»

**ä¸å¯ä»¥ï¼š**
- âŒ ç”Ÿäº§ç¯å¢ƒçš„å®æ—¶ä¸šåŠ¡
- âŒ å¯¹å¤–æš´éœ²çš„æœåŠ¡
- âŒ éœ€è¦äº‹åŠ¡ä¿è¯çš„æ“ä½œ
- âŒ é«˜å¹¶å‘åœºæ™¯

---

## ğŸ’¡ æœ€ç»ˆå»ºè®®

**ç°åœ¨ï¼ˆæœ¬åœ°å¼€å‘ï¼‰ï¼š**
```python
# å¯ä»¥ä½¿ç”¨ MongoDB ç›´è¿è°ƒè¯•
python3 get_messages_mongodb.py 7179594694
```

**ä¸Šäº‘åï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š**
```python
# å¿…é¡»ä½¿ç”¨ REST API
python3 experiment_history.py  # ä¿®å¤ maxSeq å
```

**æ•°æ®åˆ†æéœ€æ±‚ï¼š**
```python
# ä½¿ç”¨åªè¯»å‰¯æœ¬æˆ–æ•°æ®åŒæ­¥
# ç»ä¸ç›´è¿ç”Ÿäº§ä¸»åº“
```

**æ€»ç»“ä¸€å¥è¯ï¼š**
> ç›´è¿ MongoDB æ˜¯**å¼€å‘è°ƒè¯•çš„æƒå®œä¹‹è®¡**ï¼Œä¸æ˜¯ç”Ÿäº§ç¯å¢ƒçš„é•¿æœŸæ–¹æ¡ˆã€‚
> ä¸Šäº‘ååº”è¯¥**ä¼˜å…ˆä¿®å¤ OpenIM çš„ maxSeq é—®é¢˜**ï¼Œä½¿ç”¨æ ‡å‡†çš„ REST APIã€‚
